<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.clinbrain.dip.rest.mapper.DBDimensionMapper">

    <select id="selectDimsByModelId" parameterType="Integer" resultType="dimension">
        SELECT *
        FROM kylin_dimension a join kylin_dimension_model b on a.id = b.dimension_id
        WHERE b.model_id = #{modelId}
    </select>

    <insert id="insertModelDimension" parameterType="int" useGeneratedKeys="true">
        INSERT INTO kylin_dimension_model (dimension_id, model_id) VALUES (#{modelDimensionId}, #{modelId})
    </insert>

    <select id="selectModelDimension" parameterType="int" resultType="modelDimension">
        SELECT
            dimension_id,
            model_id
        FROM `kylin_dimension_model`
        WHERE model_id = #{modelId}
    </select>

    <delete id="deleteModelDimensionByModelId" parameterType="int">
        DELETE FROM kylin_dimension_model
        WHERE model_id = #{modelId}
    </delete>

    <select id="selectDimensionAsRowkey" parameterType="int" resultType="dimensionRowKey">
SELECT DISTINCT
    CASE WHEN a.dimension_type LIKE 'normal%' THEN CONCAT( a.`table`, ".", a.`column` )
	WHEN a.dimension_type = 'derived' THEN CONCAT( d.fact_table, ".", c.foreign_key )
	END AS rowkey_column,
	b.model_id
FROM
	kylin_dimension a
	JOIN kylin_dimension_model b ON a.id = b.dimension_id
	LEFT JOIN kylin_modellookup c ON a.TABLE = c.TABLE AND b.model_id = c.model_id
	JOIN kylin_model d ON d.id = c.model_id
WHERE
	( a.dimension_type LIKE 'normal%' OR a.dimension_type = 'derived' )
	AND b.model_id =#{modelId}
    </select>


    <insert id="appendDimensionRowkey" parameterType="dimensionRowKey" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO kylin_dimensionrowkey(rowkey_column,rowkey_sort,created_at,updated_at,model_id,rowkey_encoding,rowkey_issharedby)
        VALUES(#{rowkeyColumn},#{rowkeySort},now(),now(),#{modelId},#{rowkeyEncoding},#{rowkeyIssharedby})
    </insert>

    <delete id="deleteDimensionRowkeyByModelId" parameterType="int">
        delete from kylin_dimensionrowkey WHERE model_id=#{modelId}
    </delete>

    <delete id="deleteDimensionByTable" parameterType="String">
        delete from kylin_dimension WHERE `table`=#{table} and dimension_type='derived'
    </delete>

    <select id="selectModelDimensionByDimensionId" parameterType="List" resultType="modelMeta">
        SELECT model_name FROM  kylin_model WHERE id IN (SELECT DISTINCT(model_id) FROM kylin_dimension_model
        <where>
            dimension_id IN
            <foreach item="did" index="index" collection="dimensionId" open="(" separator="," close=")">
                #{did}
            </foreach>
        </where>)
    </select>
</mapper>